def run_samba_writer(text, tone, keyword):
    try:
        client = OpenAI(
            api_key=st.secrets["SAMBANOVA_API_KEY"],
            base_url="https://api.sambanova.ai/v1",
        )

        prompt = f"""
برومت الصياغة الصحفية النخبوية المنضبطة (نسخة مُصحَّحة تقنيًا)

المهمة:
أعد صياغة النص بأسلوب صحفي احترافي نخبوّي، صالح للنشر في جريدة ورقية ومواقع إخبارية كبرى، مع الالتزام الصارم بالقواعد التالية دون أي اجتهاد خارجها:

1. النفس التحريري المتوازن
اكتب بجمل مركبة ومترابطة، لكن دون إفراط.
الحد الأقصى لطول الجملة: 25 كلمة.
امزج بين الجمل الطويلة والمتوسطة لتفادي الإرهاق القرائي.
يُمنع تكديس أكثر من 3 أفكار داخل الجملة الواحدة.

2. منع المبني للمجهول (قاعدة صارمة)
يجب ألا تتجاوز نسبة المبني للمجهول 10% كحد أقصى.
كل جملة خبرية يجب أن تحتوي على فاعل واضح وصريح.
استخدم أفعالًا مباشرة مثل:
شهدت، أطلقت، باشرت، نظمت، انخرطت، بادر، عملت، أكدت، وسعت، جددت.
يُمنع استعمال صيغ مثل:
تم، جرى، يتم، تم تسجيل، تم تنظيم، تم الإعلان.

3. تنويع بدايات الجمل (قاعدة إلزامية)
يُمنع بدء أكثر من جملتين متتاليتين بنفس الكلمة أو التركيب.
نوّع بدايات الجمل بين:
ظرف زمان، ظرف مكان، فعل مباشر، جملة وصفية، تركيب سياقي.

4. بنية الفقرة الصحفية
كل فقرة يجب أن تتكون من فكرة واحدة مكتملة.
تبدأ الفقرة بمدخل قوي واضح، وتُدعَّم بتفاصيل دقيقة دون حشو.
يمنع الانتقال بين أفكار غير مترابطة داخل نفس الفقرة.

5. اللغة الصحفية الحديثة
استخدم تعابير مثل:
وفي هذا السياق، فور وقوع الواقعة، حسب معطيات أولية، بالتوازي مع ذلك، وأسفر هذا الإجراء عن، ويعيد هذا المعطى إلى الواجهة.

6. العنوان الرئيسي
يبدأ بالكلمة المفتاحية {keyword}.
يكون طويلاً ووصفيًا ويعكس جوهر الحدث بدقة.

7. العناوين الفرعية
إدراج عناوين فرعية نصية فقط عند الانتقال بين الزوايا.
الحد الأدنى ثلاثة عناوين إذا كان النص طويلاً.

8. نظافة النص
يمنع استعمال الرموز، النجوم، الهاشتاغات، الإيموجي.
النص صالح للطباعة الورقية دون تعديل.

9. منع المقدمات الآلية
لا تستخدم عبارات تمهيدية.
ابدأ مباشرة بالعنوان ثم المتن.

أسلوب الصياغة: {tone}
الكلمة المفتاحية: {keyword}

النص الأصلي:
{text[:4500]}
"""

        response = client.chat.completions.create(
            model="Meta-Llama-3.3-70B-Instruct",
            messages=[
                {
                    "role": "system",
                    "content": "أنت كاتب صحفي محترف جداً تكتب بلغة عربية قوية ومباشرة وبمبني معلوم."
                },
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            temperature=0.5,
            top_p=0.9
        )

        return response.choices[0].message.content

    except Exception as e:
        return f"خطأ تقني في الاتصال بمحرك SambaNova: {str(e)}"
